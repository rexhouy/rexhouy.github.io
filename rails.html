<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>rails</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<meta name="title" content="rails"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2015-06-25T21:38+0800"/>
<meta name="author" content="rexhouy"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<meta name='viewport' content='width=device-width, initial-scale=1.0'>
<link rel='stylesheet' type='text/css' href='emacs-org-html-style/org-style.css' media='only screen' />
<link rel='stylesheet' type='text/css' href='emacs-org-html-style/org-style-min-640px.css' media='only screen and (min-width: 640px) and (max-width: 960px)' />
<link rel='stylesheet' type='text/css' href='emacs-org-html-style/org-style-max-640px.css' media='only screen and (max-width: 640px)' />
<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
<script src='https://code.jquery.com/jquery-2.1.3.min.js'></script>
<script src='emacs-org-html-style/nav.js'></script>


</head>
<body>

<div id="preamble">

</div>

<div id="content">
<h1 class="title">rails</h1>


<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">Gem source</a></li>
<li><a href="#sec-2">Rails script</a></li>
<li><a href="#sec-3">Rails coding</a>
<ul>
<li><a href="#sec-3-1">Strong parameters check</a></li>
<li><a href="#sec-3-2">Validate</a></li>
<li><a href="#sec-3-3">Set parameters for application.html.erb</a></li>
</ul>
</li>
<li><a href="#sec-4">Views</a>
<ul>
<li><a href="#sec-4-1">Path helper</a></li>
<li><a href="#sec-4-2">Asset helper</a></li>
<li><a href="#sec-4-3">Partials</a></li>
<li><a href="#sec-4-4">Date helper</a></li>
<li><a href="#sec-4-5">Debug helper</a></li>
<li><a href="#sec-4-6">Form helper</a></li>
<li><a href="#sec-4-7">Number helper</a></li>
<li><a href="#sec-4-8">Request object</a></li>
<li><a href="#sec-4-9">Response object</a></li>
<li><a href="#sec-4-10">Global exception handling</a></li>
<li><a href="#sec-4-11">Force https</a></li>
</ul>
</li>
<li><a href="#sec-5">Routs</a></li>
<li><a href="#sec-6">DB migration</a>
<ul>
<li><a href="#sec-6-1">Create</a></li>
<li><a href="#sec-6-2">Update</a></li>
<li><a href="#sec-6-3">Delete</a></li>
<li><a href="#sec-6-4">Index</a></li>
</ul>
</li>
<li><a href="#sec-7">ActiveRecord</a>
<ul>
<li><a href="#sec-7-1">Naming conventions</a></li>
<li><a href="#sec-7-2">Create</a></li>
<li><a href="#sec-7-3">Read</a>
<ul>
<li><a href="#sec-7-3-1">Query methods</a></li>
<li><a href="#sec-7-3-2">Eager loading</a></li>
<li><a href="#sec-7-3-3">Scopes</a></li>
<li><a href="#sec-7-3-4">Dynamic finders</a></li>
</ul>
</li>
<li><a href="#sec-7-4">Update</a></li>
<li><a href="#sec-7-5">Delete</a></li>
<li><a href="#sec-7-6">Callbacks</a></li>
<li><a href="#sec-7-7">Validations</a></li>
<li><a href="#sec-7-8">Associations</a>
<ul>
<li><a href="#sec-7-8-1">Type of associations</a></li>
<li><a href="#sec-7-8-2">Polymorphic Associations</a></li>
<li><a href="#sec-7-8-3">Self joins</a></li>
</ul>
</li>
<li><a href="#sec-7-9">Locking</a>
<ul>
<li><a href="#sec-7-9-1">Optimistic Locking</a></li>
<li><a href="#sec-7-9-2">Pessimistic Locking</a></li>
</ul></li>
</ul>
</li>
<li><a href="#sec-8">Testing</a>
<ul>
<li><a href="#sec-8-1">Preparing data(fixtures)</a></li>
</ul>
</li>
<li><a href="#sec-9">Security</a>
<ul>
<li><a href="#sec-9-1">Session Hijacking</a></li>
<li><a href="#sec-9-2">Replay attacks</a></li>
<li><a href="#sec-9-3">Session Fixation</a></li>
<li><a href="#sec-9-4">Log files</a></li>
</ul>
</li>
<li><a href="#sec-10">Caching</a>
<ul>
<li><a href="#sec-10-1">Cache stores</a>
<ul>
<li><a href="#sec-10-1-1">Implements own store</a></li>
</ul></li>
</ul>
</li>
<li><a href="#sec-11">Debug</a>
<ul>
<li><a href="#sec-11-1">Logger</a></li>
</ul>
</li>
<li><a href="#sec-12">Others</a>
<ul>
<li>
<ul>
<li><a href="#sec-12-1">Bootstrap integration</a></li>
<li><a href="#sec-12-2">Load config files</a></li>
<li><a href="#sec-12-3">Nested attributes</a></li>
</ul></li>
</ul>
</li>
<li><a href="#sec-13">Publish</a>
<ul>
<li><a href="#sec-13-1">Install ruby with rvm</a></li>
<li><a href="#sec-13-2">install rails</a></li>
<li><a href="#sec-13-3">Using Passanger</a>
<ul>
<li><a href="#sec-13-3-1">nginx settings</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1">Gem source</h2>
<div class="outline-text-2" id="text-1">

<p>Use taobao mirror.
</p>


<pre class="src src-bash">$ gem sources --remove https://rubygems.org/
$ gem sources -a https://ruby.taobao.org/
$ gem sources -l
bundle config mirror.https://rubygems.org https://ruby.taobao.org/
</pre>

</div>

</div>

<div id="outline-container-2" class="outline-2">
<h2 id="sec-2">Rails script</h2>
<div class="outline-text-2" id="text-2">


<p>
Create a new application.
</p>



<pre class="src src-bash">rails new app_name [-d mysql -m haml]
</pre>


<p>
Start up server
</p>


<pre class="src src-bash">rails server
</pre>


<p>
Create controller
</p>


<pre class="src src-bash">// contains methods response to [./ctr_name/method1] [./ctr_name/method2]
rails g controller ctr_name [method1 method2 ...]
</pre>


<p>
Remove created controller
</p>


<pre class="src src-bash">rails d controller ctr_name
</pre>


<p>
Create resource(rest full controller and router, model)
</p>


<pre class="src src-bash">rails g resource r_name
</pre>



<p>
Create model
</p>


<pre class="src src-bash">rails g model model_name field_1:type field_2:type

// Generate db info
rake db:migrate
</pre>



<p>
List routes infomation
</p>


<pre class="src src-bash">rake routes
</pre>


</div>

</div>

<div id="outline-container-3" class="outline-2">
<h2 id="sec-3">Rails coding</h2>
<div class="outline-text-2" id="text-3">


</div>

<div id="outline-container-3-1" class="outline-3">
<h3 id="sec-3-1">Strong parameters check</h3>
<div class="outline-text-3" id="text-3-1">




<pre class="src src-ruby"><span style="color: #2aa198;">//</span> <span style="color: #268bd2;">Defines</span> avaible variables, must be <span style="color: #859900;">private</span>
<span style="color: #859900;">private</span>
<span style="color: #859900;">def</span> <span style="color: #b58900;">test_params</span>
        params.require(<span style="color: #268bd2;">:test</span>).permit(<span style="color: #268bd2;">:id</span>, <span style="color: #268bd2;">:name</span>)
<span style="color: #859900;">end</span>
</pre>


</div>

</div>

<div id="outline-container-3-2" class="outline-3">
<h3 id="sec-3-2">Validate</h3>
<div class="outline-text-3" id="text-3-2">




<pre class="src src-ruby"><span style="color: #2aa198;">//</span> validates method <span style="color: #859900;">in</span> record
validates <span style="color: #268bd2;">:id</span>, <span style="color: #268bd2;">presence</span>: <span style="color: #6c71c4;">true</span>, <span style="color: #268bd2;">length</span>: { <span style="color: #268bd2;">minimum</span>: 5 }

<span style="color: #2aa198;">//</span> validate errors <span style="color: #859900;">in</span> view
&lt;% <span style="color: #859900;">if</span> <span style="color: #6c71c4;">@model</span>.errors.any? <span style="color: #859900;">do</span> <span style="color: #2aa198;">%&gt;</span>
<span style="color: #2aa198;">        &lt;ul&gt;</span>
                &lt;% <span style="color: #6c71c4;">@model</span>.errors.full_messages.each <span style="color: #859900;">do</span> |msg| <span style="color: #2aa198;">%&gt;</span>
<span style="color: #2aa198;">                        &lt;li&gt;</span>&lt;<span style="color: #2aa198;">%= msg %&gt;&lt;/li&gt;</span>
<span style="color: #2aa198;">                &lt;% end %&gt;</span>
<span style="color: #2aa198;">        &lt;/ul&gt;</span>
<span style="color: #2aa198;">&lt;% end %&gt;</span>
</pre>


</div>

</div>

<div id="outline-container-3-3" class="outline-3">
<h3 id="sec-3-3">Set parameters for application.html.erb</h3>
<div class="outline-text-3" id="text-3-3">




<pre class="src src-ruby"><span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">Add before_action in application_controller.rb</span>
        before_action <span style="color: #268bd2;">:menu</span>

        <span style="color: #859900;">def</span> <span style="color: #b58900;">menu</span>()
                <span style="color: #6c71c4;">@menus</span> = [{<span style="color: #268bd2;">:url</span> =&gt; <span style="color: #2aa198;">"/orders"</span>, <span style="color: #268bd2;">:text</span> =&gt; <span style="color: #2aa198;">"&#35746;&#21333;&#31649;&#29702;"</span>, <span style="color: #268bd2;">:active</span> =&gt; <span style="color: #6c71c4;">false</span>},
                                                 {<span style="color: #268bd2;">:url</span> =&gt; <span style="color: #2aa198;">"/customers"</span>, <span style="color: #268bd2;">:text</span> =&gt; <span style="color: #2aa198;">"&#23458;&#25143;&#31649;&#29702;"</span>, <span style="color: #268bd2;">:active</span> =&gt; <span style="color: #6c71c4;">false</span>}]

                <span style="color: #6c71c4;">@menus</span>.each <span style="color: #859900;">do</span> |menu|
                        menu[<span style="color: #268bd2;">:active</span>] = menu[<span style="color: #268bd2;">:url</span>].eql? <span style="color: #2aa198;">"</span><span style="color: #6c71c4;">/#{params[:controller]}</span><span style="color: #2aa198;">"</span>
                <span style="color: #859900;">end</span>
        <span style="color: #859900;">end</span>

</pre>


</div>
</div>

</div>

<div id="outline-container-4" class="outline-2">
<h2 id="sec-4">Views</h2>
<div class="outline-text-2" id="text-4">


</div>

<div id="outline-container-4-1" class="outline-3">
<h3 id="sec-4-1">Path helper</h3>
<div class="outline-text-3" id="text-4-1">

<p>Take user for example
</p><table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup><col class="left" /><col class="left" /><col class="left" /><col class="left" /><col class="left" />
</colgroup>
<thead>
<tr><th scope="col" class="left">#</th><th scope="col" class="left">URL Pattern</th><th scope="col" class="left">Method</th><th scope="col" class="left">Action</th><th scope="col" class="left">Path String</th></tr>
</thead>
<tbody>
<tr><td class="left">To List Page</td><td class="left">/users</td><td class="left">GET</td><td class="left">index</td><td class="left">users_path</td></tr>
<tr><td class="left">To Edit Page</td><td class="left">/users/id/eidt</td><td class="left">GET</td><td class="left">edit</td><td class="left">edit_user_path(@user)</td></tr>
<tr><td class="left">To Detail Page</td><td class="left">/users/id</td><td class="left">GET</td><td class="left">show</td><td class="left">user_path(@user)</td></tr>
<tr><td class="left">To Create Page</td><td class="left">/users/new</td><td class="left">GET</td><td class="left">new</td><td class="left">new_user_path</td></tr>
<tr><td class="left">Create</td><td class="left">/users</td><td class="left">POST</td><td class="left">create</td><td class="left">&mdash;</td></tr>
<tr><td class="left">Update</td><td class="left">/users/id</td><td class="left">PUT</td><td class="left">update</td><td class="left">user_path(@user), method: :put</td></tr>
<tr><td class="left">Delete</td><td class="left">/users/id</td><td class="left">DELETE</td><td class="left">destroy</td><td class="left">user_path(@user), method: :delete</td></tr>
</tbody>
</table>

</div>

</div>

<div id="outline-container-4-2" class="outline-3">
<h3 id="sec-4-2">Asset helper</h3>
<div class="outline-text-3" id="text-4-2">

<p>Images
</p>


<pre class="src src-ruby">config.action_controller.asset_host = <span style="color: #2aa198;">"assets.example.com"</span>
image_tag(<span style="color: #2aa198;">"rails.png"</span>) 
<span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">=&gt; &lt;img src="http://assets.example.com/images/rails.png" alt="Rails" /&gt;</span>
</pre>

<p>
Javascripts
</p>


<pre class="src src-ruby"><span style="color: #268bd2;">ActionView</span>::<span style="color: #268bd2;">Helpers</span>::<span style="color: #268bd2;">AssetTagHelper</span>.register_javascript_expansion <span style="color: #268bd2;">monkey</span>: [<span style="color: #2aa198;">"head"</span>, <span style="color: #2aa198;">"body"</span>, <span style="color: #2aa198;">"tail"</span>]
javascript_include_tag <span style="color: #268bd2;">:monkey</span>
<span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">=&gt;</span>
<span style="color: #93a1a1; font-style: italic;">#  </span><span style="color: #93a1a1; font-style: italic;">&lt;script src="/assets/head.js"&gt;&lt;/script&gt;</span>
<span style="color: #93a1a1; font-style: italic;">#  </span><span style="color: #93a1a1; font-style: italic;">&lt;script src="/assets/body.js"&gt;&lt;/script&gt;</span>
<span style="color: #93a1a1; font-style: italic;">#  </span><span style="color: #93a1a1; font-style: italic;">&lt;script src="/assets/tail.js"&gt;&lt;/script&gt;</span>
</pre>

<p>
Stylesheet
</p>


<pre class="src src-ruby"><span style="color: #268bd2;">ActionView</span>::<span style="color: #268bd2;">Helpers</span>::<span style="color: #268bd2;">AssetTagHelper</span>.register_stylesheet_expansion <span style="color: #268bd2;">monkey</span>: [<span style="color: #2aa198;">"head"</span>, <span style="color: #2aa198;">"body"</span>, <span style="color: #2aa198;">"tail"</span>]
stylesheet_link_tag <span style="color: #268bd2;">:monkey</span> 
<span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">=&gt;</span>
<span style="color: #93a1a1; font-style: italic;">#  </span><span style="color: #93a1a1; font-style: italic;">&lt;link href="/assets/head.css" media="screen" rel="stylesheet" /&gt;</span>
<span style="color: #93a1a1; font-style: italic;">#  </span><span style="color: #93a1a1; font-style: italic;">&lt;link href="/assets/body.css" media="screen" rel="stylesheet" /&gt;</span>
<span style="color: #93a1a1; font-style: italic;">#  </span><span style="color: #93a1a1; font-style: italic;">&lt;link href="/assets/tail.css" media="screen" rel="stylesheet" /&gt;</span>
</pre>

</div>

</div>

<div id="outline-container-4-3" class="outline-3">
<h3 id="sec-4-3">Partials</h3>
<div class="outline-text-3" id="text-4-3">

<p>Partial file name starts with "_".
</p>
<p>
Use template "_order.html.erb" &amp; "_product.html.erb"
</p>


<pre class="src src-ruby">render <span style="color: #268bd2;">partial</span>: <span style="color: #2aa198;">"order"</span>, <span style="color: #268bd2;">object</span>: <span style="color: #6c71c4;">@order</span>
render <span style="color: #6c71c4;">@order</span> <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">A shorthand syntax for the upper one. Local variable order is passed into template.</span>

render <span style="color: #268bd2;">partial</span>: <span style="color: #2aa198;">"product"</span>, <span style="color: #268bd2;">collection</span>: <span style="color: #6c71c4;">@products</span> <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">Render collections. Use product as variable in template.</span>
render <span style="color: #6c71c4;">@products</span>
</pre>

</div>

</div>

<div id="outline-container-4-4" class="outline-3">
<h3 id="sec-4-4">Date helper</h3>
<div class="outline-text-3" id="text-4-4">




<pre class="src src-ruby">date_select(<span style="color: #2aa198;">"post"</span>, <span style="color: #2aa198;">"published_on"</span>)
datetime_select(<span style="color: #2aa198;">"post"</span>, <span style="color: #2aa198;">"published_on"</span>)
distance_of_time_in_words(<span style="color: #268bd2;">Time</span>.now, <span style="color: #268bd2;">Time</span>.now + 15.seconds)  <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">=&gt; less than a minute</span>
time_ago_in_words(3.minutes.from_now)  <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">=&gt; 3 minutes</span>
</pre>

</div>

</div>

<div id="outline-container-4-5" class="outline-3">
<h3 id="sec-4-5">Debug helper</h3>
<div class="outline-text-3" id="text-4-5">




<pre class="src src-ruby">debug(my_hash) <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">Dump my_hash into yaml, useful 4 debugging</span>
</pre>

</div>

</div>

<div id="outline-container-4-6" class="outline-3">
<h3 id="sec-4-6">Form helper</h3>
<div class="outline-text-3" id="text-4-6">




<pre class="src src-ruby">&lt;<span style="color: #2aa198;">%= form_for @person, url: {action: "create"} do |f| %&gt;</span>
<span style="color: #2aa198;">  &lt;%=</span> f.label <span style="color: #268bd2;">:title</span>, <span style="color: #2aa198;">'Title'</span> <span style="color: #2aa198;">%&gt;:</span>
<span style="color: #2aa198;">  &lt;%= f.text_field :title %&gt;</span>&lt;br /&gt;
  &lt;<span style="color: #2aa198;">%= check_box("post", "validated") %&gt;</span>
<span style="color: #2aa198;">  &lt;%=</span> file_field(<span style="color: #268bd2;">:user</span>, <span style="color: #268bd2;">:avatar</span>) <span style="color: #2aa198;">%&gt;</span>
<span style="color: #2aa198;">  &lt;%= hidden_field(:user, :token) %&gt;</span>
  &lt;<span style="color: #2aa198;">%= password_field(:login, :pass) %&gt;</span>
<span style="color: #2aa198;">  &lt;%=</span> radio_button(<span style="color: #2aa198;">"post"</span>, <span style="color: #2aa198;">"category"</span>, <span style="color: #2aa198;">"rails"</span>) <span style="color: #2aa198;">%&gt;</span>
<span style="color: #2aa198;">  &lt;%= text_area(:comment, :text, size: "20x30") %&gt;</span>
  &lt;<span style="color: #2aa198;">%= collection_select(:post, :author_id, Author.all, :id, :name_with_initial, {prompt: true}) %&gt;</span>
<span style="color: #2aa198;">  &lt;%=</span> collection_radio_buttons(<span style="color: #268bd2;">:post</span>, <span style="color: #268bd2;">:author_id</span>, <span style="color: #268bd2;">Author</span>.all, <span style="color: #268bd2;">:id</span>, <span style="color: #268bd2;">:name_with_initial</span>) <span style="color: #2aa198;">%&gt;</span>
<span style="color: #2aa198;">  &lt;%= collection_check_boxes(:post, :author_ids, Author.all, :id, :name_with_initial) %&gt;</span>
  &lt;<span style="color: #2aa198;">%= submit_tag 'Create' %&gt;</span>
<span style="color: #2aa198;">&lt;% end %&gt;</span>
</pre>

</div>

</div>

<div id="outline-container-4-7" class="outline-3">
<h3 id="sec-4-7">Number helper</h3>
<div class="outline-text-3" id="text-4-7">




<pre class="src src-ruby">number_to_currency(1234567890.50) <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">=&gt; $1,234,567,890.50</span>
number_to_human_size(1234)          <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">=&gt; 1.2 KB</span>
number_to_percentage(100, <span style="color: #268bd2;">:precision</span> =&gt; 0)        <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">=&gt; 100%</span>
number_to_phone(1235551234) <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">=&gt; 123-555-1234</span>
number_with_delimiter(12345678) <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">=&gt; 12,345,678</span>
number_with_precision(111.2345, 2)  <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">=&gt; 111.23</span>
</pre>

</div>

</div>

<div id="outline-container-4-8" class="outline-3">
<h3 id="sec-4-8">Request object</h3>
<div class="outline-text-3" id="text-4-8">

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup><col class="left" /><col class="left" />
</colgroup>
<thead>
<tr><th scope="col" class="left">Property of request</th><th scope="col" class="left">Purpose</th></tr>
</thead>
<tbody>
<tr><td class="left">host</td><td class="left">The hostname used for this request.</td></tr>
<tr><td class="left">domain(n=2)</td><td class="left">The hostname's first n segments, starting from the right (the TLD).</td></tr>
<tr><td class="left">format</td><td class="left">The content type requested by the client.</td></tr>
<tr><td class="left">method</td><td class="left">The HTTP method used for the request.</td></tr>
<tr><td class="left">get?, post?, patch?, put?, delete?, head?</td><td class="left">Returns true if the HTTP method is GET/POST/PATCH/PUT/DELETE/HEAD.</td></tr>
<tr><td class="left">headers</td><td class="left">Returns a hash containing the headers associated with the request.</td></tr>
<tr><td class="left">port</td><td class="left">The port number (integer) used for the request.</td></tr>
<tr><td class="left">protocol</td><td class="left">Returns a string containing the protocol used plus "://".</td></tr>
<tr><td class="left">query_string</td><td class="left">The query string part of the URL, i.e., everything after "?".</td></tr>
<tr><td class="left">remote_ip</td><td class="left">The IP address of the client.</td></tr>
<tr><td class="left">url</td><td class="left">The entire URL used for the request.</td></tr>
</tbody>
</table>

</div>

</div>

<div id="outline-container-4-9" class="outline-3">
<h3 id="sec-4-9">Response object</h3>
<div class="outline-text-3" id="text-4-9">

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup><col class="left" /><col class="left" />
</colgroup>
<thead>
<tr><th scope="col" class="left">Property of response</th><th scope="col" class="left">Purpose</th></tr>
</thead>
<tbody>
<tr><td class="left">body</td><td class="left">This is the string of data being sent back to the client. This is most often HTML.</td></tr>
<tr><td class="left">status</td><td class="left">The HTTP status code for the response, like 200 for a successful request or 404 for file not found.</td></tr>
<tr><td class="left">location</td><td class="left">The URL the client is being redirected to, if any.</td></tr>
<tr><td class="left">content_type</td><td class="left">The content type of the response.</td></tr>
<tr><td class="left">charset</td><td class="left">The character set being used for the response. Default is "utf-8".</td></tr>
<tr><td class="left">headers</td><td class="left">Headers used for the response.</td></tr>
</tbody>
</table>

</div>

</div>

<div id="outline-container-4-10" class="outline-3">
<h3 id="sec-4-10">Global exception handling</h3>
<div class="outline-text-3" id="text-4-10">




<pre class="src src-ruby"><span style="color: #859900;">class</span> <span style="color: #268bd2;">ApplicationController</span> &lt; <span style="color: #268bd2;">ActionController</span>::<span style="color: #268bd2;">Base</span>
  rescue_from <span style="color: #268bd2;">ActiveRecord</span>::<span style="color: #268bd2;">RecordNotFound</span>, <span style="color: #268bd2;">with</span>: <span style="color: #268bd2;">:record_not_found</span>

  <span style="color: #859900;">private</span>
  <span style="color: #859900;">def</span> <span style="color: #b58900;">record_not_found</span>
    render <span style="color: #268bd2;">text</span>: <span style="color: #2aa198;">"404 Not Found"</span>, <span style="color: #268bd2;">status</span>: 404
  <span style="color: #859900;">end</span>
<span style="color: #859900;">end</span>
</pre>

</div>

</div>

<div id="outline-container-4-11" class="outline-3">
<h3 id="sec-4-11">Force https</h3>
<div class="outline-text-3" id="text-4-11">




<pre class="src src-ruby"><span style="color: #859900;">class</span> <span style="color: #268bd2;">DinnerController</span>
  force_ssl
<span style="color: #859900;">end</span>
</pre>

</div>
</div>

</div>

<div id="outline-container-5" class="outline-2">
<h2 id="sec-5">Routs</h2>
<div class="outline-text-2" id="text-5">




<pre class="src src-ruby">assert_routing({ <span style="color: #268bd2;">path</span>: <span style="color: #2aa198;">'photos'</span>, <span style="color: #268bd2;">method</span>: <span style="color: #268bd2;">:post</span> }, { <span style="color: #268bd2;">controller</span>: <span style="color: #2aa198;">'photos'</span>, <span style="color: #268bd2;">action</span>: <span style="color: #2aa198;">'create'</span> })
</pre>

</div>

</div>

<div id="outline-container-6" class="outline-2">
<h2 id="sec-6">DB migration</h2>
<div class="outline-text-2" id="text-6">

<p>Create db
</p>


<pre class="src src-bash">rake db:create
</pre>

<p>
Drop db
</p>


<pre class="src src-bash">rake db:drop
</pre>

<p>
Change db
</p>


<pre class="src src-bash">rails g migration CreateMap
rails g migration AddTypeToMap
</pre>

<p>
Supported data types:
</p><table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup><col class="left" />
</colgroup>
<tbody>
<tr><td class="left">:primary_key</td></tr>
<tr><td class="left">:string</td></tr>
<tr><td class="left">:text</td></tr>
<tr><td class="left">:integer</td></tr>
<tr><td class="left">:float</td></tr>
<tr><td class="left">:decimal</td></tr>
<tr><td class="left">:datetime</td></tr>
<tr><td class="left">:timestamp</td></tr>
<tr><td class="left">:time</td></tr>
<tr><td class="left">:date</td></tr>
<tr><td class="left">:binary</td></tr>
<tr><td class="left">:boolean</td></tr>
<tr><td class="left">:references</td></tr>
</tbody>
</table>

Supported
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup><col class="left" /><col class="left" />
</colgroup>
<tbody>
<tr><td class="left">limit</td><td class="left">Sets the maximum size of the string/text/binary/integer fields</td></tr>
<tr><td class="left">precision</td><td class="left">Defines the precision for the decimal fields</td></tr>
<tr><td class="left">scale</td><td class="left">Defines the scale for the decimal fields</td></tr>
<tr><td class="left">polymorphic</td><td class="left">Adds a type column for belongs_to associations</td></tr>
<tr><td class="left">null</td><td class="left">Allows or disallows NULL values in the column.</td></tr>
</tbody>
</table>



</div>

<div id="outline-container-6-1" class="outline-3">
<h3 id="sec-6-1">Create</h3>
<div class="outline-text-3" id="text-6-1">




<pre class="src src-ruby"><span style="color: #859900;">def</span> <span style="color: #b58900;">change</span>
        create_table <span style="color: #268bd2;">:products</span> <span style="color: #859900;">do</span> |t|
                t.string <span style="color: #268bd2;">:name</span>, <span style="color: #268bd2;">index</span>: <span style="color: #6c71c4;">true</span>
                t.text <span style="color: #268bd2;">:description</span>
                t.decimal <span style="color: #268bd2;">:price</span>, <span style="color: #268bd2;">precision</span>: 2, <span style="color: #268bd2;">scale</span>: 5, <span style="color: #268bd2;">null</span>: <span style="color: #6c71c4;">false</span>

                t.timestamps
        <span style="color: #859900;">end</span>
<span style="color: #859900;">end</span>
</pre>

</div>

</div>

<div id="outline-container-6-2" class="outline-3">
<h3 id="sec-6-2">Update</h3>
<div class="outline-text-3" id="text-6-2">




<pre class="src src-ruby"><span style="color: #859900;">def</span> <span style="color: #b58900;">change</span>
        add_column <span style="color: #268bd2;">:products</span>, <span style="color: #268bd2;">:part_number</span>, <span style="color: #268bd2;">:string</span>

        add_index <span style="color: #268bd2;">:products</span>, <span style="color: #268bd2;">:name</span>

        add_reference <span style="color: #268bd2;">:products</span>, <span style="color: #268bd2;">:user</span>, <span style="color: #268bd2;">index</span>: <span style="color: #6c71c4;">true</span>

        add_timestamps

        create_join_table <span style="color: #268bd2;">:products</span>, <span style="color: #268bd2;">:categories</span> <span style="color: #859900;">do</span> |t|
                t.index <span style="color: #268bd2;">:product_id</span> <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">Not necessary</span>
                t.index <span style="color: #268bd2;">:category_id</span> <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">Not necessary</span>
        <span style="color: #859900;">end</span>

        change_table <span style="color: #268bd2;">:products</span> <span style="color: #859900;">do</span> |t|
                t.remove <span style="color: #268bd2;">:description</span>, <span style="color: #268bd2;">:name</span>
                t.string <span style="color: #268bd2;">:part_number</span>
                t.index <span style="color: #268bd2;">:part_number</span>
                t.rename <span style="color: #268bd2;">:upccode</span>, <span style="color: #268bd2;">:upc_code</span>
        <span style="color: #859900;">end</span>

        rename_column <span style="color: #268bd2;">:users</span>, <span style="color: #268bd2;">:email</span>, <span style="color: #268bd2;">:email_address</span>

        rename_index

        rename_table <span style="color: #268bd2;">:users</span>, <span style="color: #268bd2;">:customers</span>

<span style="color: #859900;">end</span>
</pre>

</div>

</div>

<div id="outline-container-6-3" class="outline-3">
<h3 id="sec-6-3">Delete</h3>
<div class="outline-text-3" id="text-6-3">




<pre class="src src-ruby"><span style="color: #859900;">def</span> <span style="color: #b58900;">change</span>
        remove_column <span style="color: #268bd2;">:products</span>, <span style="color: #268bd2;">:part_number</span>, <span style="color: #268bd2;">:string</span>

        drop_table <span style="color: #268bd2;">:users</span>

        drop_join_table <span style="color: #268bd2;">:products</span>, <span style="color: #268bd2;">:users</span>

        remove_timestamps

        remove_reference <span style="color: #268bd2;">:products</span>, <span style="color: #268bd2;">:user</span>

<span style="color: #859900;">end</span>
</pre>

</div>

</div>

<div id="outline-container-6-4" class="outline-3">
<h3 id="sec-6-4">Index</h3>
<div class="outline-text-3" id="text-6-4">




<pre class="src src-ruby"><span style="color: #859900;">def</span> <span style="color: #b58900;">change</span>
        add_index <span style="color: #268bd2;">:products</span>, <span style="color: #268bd2;">:part_number</span>

        add_reference <span style="color: #268bd2;">:products</span>, <span style="color: #268bd2;">:user</span>, <span style="color: #268bd2;">index</span>: <span style="color: #6c71c4;">true</span> <span style="color: #93a1a1; font-style: italic;">#</span><span style="color: #93a1a1; font-style: italic;">belongs_to relation, Remember not to use :users</span>
<span style="color: #859900;">end</span>

<span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">Use up down method to handle reversable operations</span>
<span style="color: #859900;">def</span> <span style="color: #b58900;">up</span>
        <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">add a foreign key</span>
        execute <span style="color: #2aa198;">&lt;&lt;-SQL</span>
<span style="color: #2aa198;">                ALTER TABLE products</span>
<span style="color: #2aa198;">                        ADD CONSTRAINT fk_products_categories</span>
<span style="color: #2aa198;">                        FOREIGN KEY (category_id)</span>
<span style="color: #2aa198;">                        REFERENCES categories(id)</span>
<span style="color: #2aa198;">        SQL</span>
<span style="color: #859900;">end</span>

<span style="color: #859900;">def</span> <span style="color: #b58900;">down</span>
        execute <span style="color: #2aa198;">&lt;&lt;-SQL</span>
<span style="color: #2aa198;">                ALTER TABLE products</span>
<span style="color: #2aa198;">                        DROP FOREIGN KEY fk_products_categories</span>
<span style="color: #2aa198;">        SQL</span>
<span style="color: #859900;">end</span>
</pre>

</div>
</div>

</div>

<div id="outline-container-7" class="outline-2">
<h2 id="sec-7">ActiveRecord</h2>
<div class="outline-text-2" id="text-7">


</div>

<div id="outline-container-7-1" class="outline-3">
<h3 id="sec-7-1">Naming conventions</h3>
<div class="outline-text-3" id="text-7-1">

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup><col class="left" /><col class="left" /><col class="left" /><col class="left" />
</colgroup>
<thead>
<tr><th scope="col" class="left">Class</th><th scope="col" class="left">Schema</th><th scope="col" class="left">Foreign keys</th><th scope="col" class="left">Primary key</th></tr>
</thead>
<tbody>
<tr><td class="left">Post</td><td class="left">posts</td><td class="left">post_id</td><td class="left">id</td></tr>
<tr><td class="left">LineItem</td><td class="left">line_items</td><td class="left">line_item_id</td><td class="left">id</td></tr>
</tbody>
</table>

</div>

</div>

<div id="outline-container-7-2" class="outline-3">
<h3 id="sec-7-2">Create</h3>
<div class="outline-text-3" id="text-7-2">

<p>Create &amp; save
</p>


<pre class="src src-ruby"><span style="color: #268bd2;">User</span>.create(<span style="color: #268bd2;">name</span>: <span style="color: #2aa198;">'Rex'</span>, <span style="color: #268bd2;">occupation</span>: <span style="color: #2aa198;">'Code Plumber'</span>)
<span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">Equals</span>
user = <span style="color: #268bd2;">User</span>.new <span style="color: #859900;">do</span> |u|
        u.name = <span style="color: #2aa198;">"Rex"</span>
        u.occupation = <span style="color: #2aa198;">"Code Plumber"</span>
<span style="color: #859900;">end</span>
user.save
</pre>

</div>

</div>

<div id="outline-container-7-3" class="outline-3">
<h3 id="sec-7-3">Read</h3>
<div class="outline-text-3" id="text-7-3">


</div>

<div id="outline-container-7-3-1" class="outline-4">
<h4 id="sec-7-3-1">Query methods</h4>
<div class="outline-text-4" id="text-7-3-1">




<pre class="src src-ruby"><span style="color: #268bd2;">User</span>.all
<span style="color: #268bd2;">User</span>.first
<span style="color: #268bd2;">User</span>.find_by(<span style="color: #268bd2;">name</span>: <span style="color: #2aa198;">"Rex"</span>)
<span style="color: #268bd2;">User</span>.where(<span style="color: #268bd2;">name</span>: <span style="color: #2aa198;">"Rex"</span>, <span style="color: #268bd2;">occupation</span>: <span style="color: #2aa198;">"Code Plumber"</span>).order(<span style="color: #2aa198;">"created_at desc"</span>)
</pre>

<p>
Every methods has a .*! version, those methods will throw an exception if no record can be found.
</p><table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup><col class="left" /><col class="left" /><col class="left" /><col class="left" />
</colgroup>
<thead>
<tr><th scope="col" class="left">Methods</th><th scope="col" class="left">Function</th><th scope="col" class="left">Parameters</th><th scope="col" class="left">Example</th></tr>
</thead>
<tbody>
<tr><td class="left">take</td><td class="left">Find records without ordering</td><td class="left">limit(optional)</td><td class="left"></td></tr>
<tr><td class="left">first</td><td class="left">Find the 1st record ordered by primary key</td><td class="left">limit(optional)</td><td class="left"></td></tr>
<tr><td class="left">last</td><td class="left">Find the last record ordered by primary key</td><td class="left">limit(optional)</td><td class="left"></td></tr>
<tr><td class="left">find_by</td><td class="left">Find the 1st record by condition</td><td class="left">name: value</td><td class="left"></td></tr>
<tr><td class="left">find</td><td class="left">Find multiple records by primary key</td><td class="left">[primary_key]</td><td class="left"></td></tr>
<tr><td class="left">find_each</td><td class="left">Find all records and handle these records in block(use batch)</td><td class="left">block</td><td class="left">T</td></tr>
<tr><td class="left">all</td><td class="left">Find all records</td><td class="left"></td><td class="left"></td></tr>
<tr><td class="left">count</td><td class="left">Find count</td><td class="left"></td><td class="left"></td></tr>
<tr><td class="left">minimum</td><td class="left"></td><td class="left">field</td><td class="left"></td></tr>
<tr><td class="left">maximum</td><td class="left"></td><td class="left">field</td><td class="left"></td></tr>
<tr><td class="left">exists?</td><td class="left">Check if the record exists</td><td class="left">id or none</td><td class="left"></td></tr>
</tbody>
</table>




<pre class="src src-ruby"><span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">start &amp; batch_size is optional</span>
<span style="color: #268bd2;">User</span>.find_each(<span style="color: #268bd2;">start</span>: 2000, <span style="color: #268bd2;">batch_size</span>: 5000) <span style="color: #859900;">do</span> |user|
        <span style="color: #268bd2;">NewsLetter</span>.weekly_deliver(user)
<span style="color: #859900;">end</span>
</pre>

<p>
Every methods below returns a chainable relation object(ActiveRecord::Relation).
</p><table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup><col class="left" /><col class="left" /><col class="left" /><col class="left" />
</colgroup>
<thead>
<tr><th scope="col" class="left">Methods</th><th scope="col" class="left">Function</th><th scope="col" class="left">Parameters</th><th scope="col" class="left">Example</th></tr>
</thead>
<tbody>
<tr><td class="left">where</td><td class="left"></td><td class="left">sql, param / hash</td><td class="left">T</td></tr>
<tr><td class="left">select</td><td class="left">Set select fields</td><td class="left">fields</td><td class="left">T</td></tr>
<tr><td class="left">limit</td><td class="left">Set records limit</td><td class="left">limit</td><td class="left"></td></tr>
<tr><td class="left">offset</td><td class="left">Set offset</td><td class="left">number</td><td class="left"></td></tr>
<tr><td class="left">group</td><td class="left"></td><td class="left"></td><td class="left"></td></tr>
<tr><td class="left">having</td><td class="left"></td><td class="left"></td><td class="left"></td></tr>
<tr><td class="left">none</td><td class="left">returns a chainable relation with no records</td><td class="left">-</td><td class="left"></td></tr>
<tr><td class="left">joins</td><td class="left">joins tables together</td><td class="left"></td><td class="left">T</td></tr>
</tbody>
</table>




<pre class="src src-ruby"><span style="color: #268bd2;">User</span>.where(<span style="color: #2aa198;">"name = ?"</span>, params[<span style="color: #268bd2;">:name</span>])
<span style="color: #268bd2;">User</span>.where(<span style="color: #2aa198;">"name = :name"</span>, {<span style="color: #268bd2;">name</span>: params[<span style="color: #268bd2;">:name</span>]})
<span style="color: #268bd2;">User</span>.where(<span style="color: #2aa198;">"name"</span> =&gt; params[<span style="color: #268bd2;">:name</span>])
<span style="color: #268bd2;">User</span>.where(<span style="color: #268bd2;">name</span>: params[<span style="color: #268bd2;">:name</span>])
<span style="color: #268bd2;">User</span>.joins(<span style="color: #268bd2;">:address</span>).where(<span style="color: #268bd2;">address</span>: {<span style="color: #268bd2;">nation</span>: params[<span style="color: #268bd2;">:nation</span>]}) <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">Nested attributes</span>
<span style="color: #268bd2;">User</span>.where(<span style="color: #268bd2;">age</span>: 12..15) <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">Between X and Y</span>
<span style="color: #268bd2;">User</span>.where(<span style="color: #268bd2;">name</span>: [<span style="color: #2aa198;">"Homer"</span>, <span style="color: #2aa198;">"Bart"</span>]) <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">in</span>
<span style="color: #268bd2;">User</span>.where.not(<span style="color: #268bd2;">name</span>: <span style="color: #2aa198;">"Homer"</span>)
<span style="color: #268bd2;">Client</span>.order(<span style="color: #268bd2;">name</span>: <span style="color: #268bd2;">:asc</span>, <span style="color: #268bd2;">age</span>: <span style="color: #268bd2;">:desc</span>)
</pre>



<pre class="src src-ruby"><span style="color: #268bd2;">User</span>.select(<span style="color: #268bd2;">:name</span>).distinct
</pre>



<pre class="src src-ruby"><span style="color: #268bd2;">User</span>.joins(<span style="color: #268bd2;">:address</span>, <span style="color: #268bd2;">:articles</span>) <span style="color: #93a1a1; font-style: italic;">#</span><span style="color: #93a1a1; font-style: italic;">join multiple tables</span>
<span style="color: #268bd2;">User</span>.joins(<span style="color: #268bd2;">address</span>: <span style="color: #268bd2;">:nations</span>) <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">Nested join</span>
</pre>


<p>
Using SQL
</p>


<pre class="src src-ruby"><span style="color: #268bd2;">Client</span>.connection.select_all(<span style="color: #2aa198;">"SELECT * FROM clients WHERE id = '1'"</span>) <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">Return array of hashes.</span>
</pre>

</div>

</div>

<div id="outline-container-7-3-2" class="outline-4">
<h4 id="sec-7-3-2">Eager loading</h4>
<div class="outline-text-4" id="text-7-3-2">

<p>Associated records are loaded when it is used.
</p>
<p>
There are some methods to eagerly load those records.
</p>


<pre class="src src-ruby"><span style="color: #268bd2;">User</span>.includes(<span style="color: #268bd2;">:address</span>).limit(10)
</pre>

</div>

</div>

<div id="outline-container-7-3-3" class="outline-4">
<h4 id="sec-7-3-3">Scopes</h4>
<div class="outline-text-4" id="text-7-3-3">

<p>Predefine a query(condition) that can be used easily as method.
</p>
<p>
scope methods should return a ActiveRecord::Relation object.
</p>
<p>
default scopes are applied to all queries.
</p>


<pre class="src src-ruby">scope <span style="color: #268bd2;">:local</span> -&gt; (value) { where(<span style="color: #268bd2;">nations</span>: value) }
<span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">Previous is the same as the following</span>
<span style="color: #859900;">def</span> <span style="color: #b58900;">self.local</span>(value)
        where(<span style="color: #268bd2;">nations</span>: value)
<span style="color: #859900;">end</span>
<span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">Default scope</span>
default_scope { where(<span style="color: #2aa198;">"removed_at IS NULL"</span>) }
<span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">Using scopes</span>
<span style="color: #268bd2;">User</span>.local(<span style="color: #2aa198;">"china"</span>).all
</pre>

</div>

</div>

<div id="outline-container-7-3-4" class="outline-4">
<h4 id="sec-7-3-4">Dynamic finders</h4>
<div class="outline-text-4" id="text-7-3-4">

<p>ActiveRecord defined query methods for every fields. Use find_by_field_name to query by field.
</p>
</div>
</div>

</div>

<div id="outline-container-7-4" class="outline-3">
<h3 id="sec-7-4">Update</h3>
<div class="outline-text-3" id="text-7-4">




<pre class="src src-ruby">user = <span style="color: #268bd2;">User</span>.find_by(<span style="color: #268bd2;">name</span>: <span style="color: #2aa198;">'David'</span>)
user.name = <span style="color: #2aa198;">'Dave'</span>
user.save

user = <span style="color: #268bd2;">User</span>.find_by(<span style="color: #268bd2;">name</span>: <span style="color: #2aa198;">'David'</span>)
user.update(<span style="color: #268bd2;">name</span>: <span style="color: #2aa198;">'Dave'</span>)
</pre>

</div>

</div>

<div id="outline-container-7-5" class="outline-3">
<h3 id="sec-7-5">Delete</h3>
<div class="outline-text-3" id="text-7-5">




<pre class="src src-ruby">user = <span style="color: #268bd2;">User</span>.find_by(<span style="color: #268bd2;">name</span>: <span style="color: #2aa198;">'David'</span>)
user.destroy
</pre>

</div>

</div>

<div id="outline-container-7-6" class="outline-3">
<h3 id="sec-7-6">Callbacks</h3>
<div class="outline-text-3" id="text-7-6">

</div>

</div>

<div id="outline-container-7-7" class="outline-3">
<h3 id="sec-7-7">Validations</h3>
<div class="outline-text-3" id="text-7-7">

</div>

</div>

<div id="outline-container-7-8" class="outline-3">
<h3 id="sec-7-8">Associations</h3>
<div class="outline-text-3" id="text-7-8">


</div>

<div id="outline-container-7-8-1" class="outline-4">
<h4 id="sec-7-8-1">Type of associations</h4>
<div class="outline-text-4" id="text-7-8-1">

<ul>
<li id="sec-7-8-1-1">belongs_to(one 2 one relation, contains foreign key)<br/>
</li>
</ul>
<ul>
<li id="sec-7-8-1-2">has_one(one 2 one relation, foreign key on other side)<br/>
</li>
</ul>
<ul>
<li id="sec-7-8-1-3">has_many(one 2 many )<br/>
</li>
</ul>
<ul>
<li id="sec-7-8-1-4">has_many :through(many 2 many)<br/>
</li>
</ul>
<ul>
<li id="sec-7-8-1-5">has_one :through<br/>
</li>
</ul>
<ul>
<li id="sec-7-8-1-6">has_and_belongs_to_many(direct many-to-many table name must be tableA_tableB)<br/>



<pre class="src src-ruby"><span style="color: #859900;">class</span> <span style="color: #268bd2;">Assembly</span> &lt; <span style="color: #268bd2;">ActiveRecord</span>::<span style="color: #268bd2;">Base</span>
  has_and_belongs_to_many <span style="color: #268bd2;">:parts</span>
<span style="color: #859900;">end</span>

<span style="color: #859900;">class</span> <span style="color: #268bd2;">Part</span> &lt; <span style="color: #268bd2;">ActiveRecord</span>::<span style="color: #268bd2;">Base</span>
  has_and_belongs_to_many <span style="color: #268bd2;">:assemblies</span>
<span style="color: #859900;">end</span>

<span style="color: #859900;">class</span> <span style="color: #268bd2;">CreateAssembliesPartsJoinTable</span> &lt; <span style="color: #268bd2;">ActiveRecord</span>::<span style="color: #268bd2;">Migration</span>
  <span style="color: #859900;">def</span> <span style="color: #b58900;">change</span> <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">This table should not have an id, it's not an entity.</span>
    create_table <span style="color: #268bd2;">:assemblies_parts</span>, <span style="color: #268bd2;">id</span>: <span style="color: #6c71c4;">false</span> <span style="color: #859900;">do</span> |t|
      t.integer <span style="color: #268bd2;">:assembly_id</span>
      t.integer <span style="color: #268bd2;">:part_id</span>
    <span style="color: #859900;">end</span>
  <span style="color: #859900;">end</span>
<span style="color: #859900;">end</span>
</pre>

</li>
</ul>
</div>

</div>

<div id="outline-container-7-8-2" class="outline-4">
<h4 id="sec-7-8-2">Polymorphic Associations</h4>
<div class="outline-text-4" id="text-7-8-2">

<p>Picture would belongs to both product &amp; employee. In this situation the PICTURES table should contain a foreign key named "IMAGEABLE_ID".
</p>


<pre class="src src-ruby"><span style="color: #859900;">class</span> <span style="color: #268bd2;">Picture</span> &lt; <span style="color: #268bd2;">ActiveRecord</span>::<span style="color: #268bd2;">Base</span>
  belongs_to <span style="color: #268bd2;">:imageable</span>, <span style="color: #268bd2;">polymorphic</span>: <span style="color: #6c71c4;">true</span>
<span style="color: #859900;">end</span>

<span style="color: #859900;">class</span> <span style="color: #268bd2;">Employee</span> &lt; <span style="color: #268bd2;">ActiveRecord</span>::<span style="color: #268bd2;">Base</span>
  has_many <span style="color: #268bd2;">:pictures</span>, <span style="color: #268bd2;">as</span>: <span style="color: #268bd2;">:imageable</span>
<span style="color: #859900;">end</span>

<span style="color: #859900;">class</span> <span style="color: #268bd2;">Product</span> &lt; <span style="color: #268bd2;">ActiveRecord</span>::<span style="color: #268bd2;">Base</span>
  has_many <span style="color: #268bd2;">:pictures</span>, <span style="color: #268bd2;">as</span>: <span style="color: #268bd2;">:imageable</span>
<span style="color: #859900;">end</span>
</pre>

<p>
Foreign key definition in migration file.
</p>


<pre class="src src-ruby">t.references <span style="color: #268bd2;">:imageable</span>, <span style="color: #268bd2;">polymorphic</span>: <span style="color: #6c71c4;">true</span>
</pre>

</div>

</div>

<div id="outline-container-7-8-3" class="outline-4">
<h4 id="sec-7-8-3">Self joins</h4>
<div class="outline-text-4" id="text-7-8-3">




<pre class="src src-ruby"><span style="color: #859900;">class</span> <span style="color: #268bd2;">Employee</span> &lt; <span style="color: #268bd2;">ActiveRecord</span>::<span style="color: #268bd2;">Base</span>
  has_many <span style="color: #268bd2;">:subordinates</span>, <span style="color: #268bd2;">class_name</span>: <span style="color: #2aa198;">"Employee"</span>,
                          <span style="color: #268bd2;">foreign_key</span>: <span style="color: #2aa198;">"manager_id"</span>

  belongs_to <span style="color: #268bd2;">:manager</span>, <span style="color: #268bd2;">class_name</span>: <span style="color: #2aa198;">"Employee"</span>
<span style="color: #859900;">end</span> 
</pre>

</div>
</div>

</div>

<div id="outline-container-7-9" class="outline-3">
<h3 id="sec-7-9">Locking</h3>
<div class="outline-text-3" id="text-7-9">


</div>

<div id="outline-container-7-9-1" class="outline-4">
<h4 id="sec-7-9-1">Optimistic Locking</h4>
<div class="outline-text-4" id="text-7-9-1">

<p>Using lock_version column to record version info. If conflict occured, an ActiveRecord::StaleObjectError will be raisen.
</p></div>

</div>

<div id="outline-container-7-9-2" class="outline-4">
<h4 id="sec-7-9-2">Pessimistic Locking</h4>
<div class="outline-text-4" id="text-7-9-2">




<pre class="src src-ruby"><span style="color: #268bd2;">Item</span>.transaction <span style="color: #859900;">do</span>
  i = <span style="color: #268bd2;">Item</span>.lock.first
  i.name = <span style="color: #2aa198;">'Jones'</span>
  i.save
<span style="color: #859900;">end</span>
<span style="color: #2aa198;">//</span> <span style="color: #268bd2;">Or</span> <span style="color: #859900;">if</span> already have the item.
item = <span style="color: #268bd2;">Item</span>.first
item.with_lock <span style="color: #859900;">do</span>
  <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">This block is called within a transaction,</span>
  <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">item is already locked.</span>
  item.increment!(<span style="color: #268bd2;">:views</span>)
<span style="color: #859900;">end</span>
</pre>

</div>
</div>
</div>

</div>

<div id="outline-container-8" class="outline-2">
<h2 id="sec-8">Testing</h2>
<div class="outline-text-2" id="text-8">


</div>

<div id="outline-container-8-1" class="outline-3">
<h3 id="sec-8-1">Preparing data(fixtures)</h3>
<div class="outline-text-3" id="text-8-1">

<p>Fixtures are located at "test/fixtures/". Following are some fixture examples.
</p>


<pre class="src src-yaml"><span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">In fixtures/categories.yml</span>
<span style="color: #6c71c4;">about</span>:
  <span style="color: #6c71c4;">name</span>: About

<span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">In fixtures/articles.yml</span>
<span style="color: #6c71c4;">one</span>:
  <span style="color: #6c71c4;">title</span>: Welcome to Rails!
  <span style="color: #6c71c4;">body</span>: Hello world!
  <span style="color: #6c71c4;">category</span>: about

</pre>



<pre class="src src-ruby"><span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">Multiple records</span>
&lt;% 1000.times <span style="color: #859900;">do</span> |n| <span style="color: #2aa198;">%&gt;</span>
<span style="color: #2aa198;">user_&lt;%= n %&gt;</span>:
  <span style="color: #268bd2;">username</span>: &lt;<span style="color: #2aa198;">%= "use</span><span style="color: #6c71c4;">r#{n}</span><span style="color: #2aa198;">" %&gt;</span>
<span style="color: #2aa198;">  email: &lt;%=</span> <span style="color: #2aa198;">"use</span><span style="color: #6c71c4;">r#{n}</span><span style="color: #2aa198;">@example.com"</span> <span style="color: #2aa198;">%&gt;</span>
<span style="color: #2aa198;">&lt;% end %&gt;</span>
</pre>

<p>
Using fixtures:
</p>


<pre class="src src-ruby"><span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">Fixtures are instances of Active Record. Use it directly in test code.</span>
user1 = <span style="color: #268bd2;">User</span>(<span style="color: #268bd2;">:user1</span>)
</pre>


<p>
Initialize test database
</p>


<pre class="src src-bash">rake db:migrate
rake db:test:load
</pre>

<p>
Rake task for testing.
</p><table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup><col class="left" /><col class="left" />
</colgroup>
<tbody>
<tr><td class="left">Tasks</td><td class="left">Description</td></tr>
<tr><td class="left">rake db:test:clone    Recreate the test database from the current environment's database schema</td></tr>
</tbody>
</table>

rake db:test:clone_structure    Recreate the test database from the development structure
rake db:test:load       Recreate the test database from the current schema.rb
rake db:test:prepare    Check for pending migrations and load the test schema
rake db:test:purge      Empty the test database.
</div>
</div>

</div>

<div id="outline-container-9" class="outline-2">
<h2 id="sec-9">Security</h2>
<div class="outline-text-2" id="text-9">


</div>

<div id="outline-container-9-1" class="outline-3">
<h3 id="sec-9-1">Session Hijacking</h3>
<div class="outline-text-3" id="text-9-1">

<p>By default sessions are saved in cookies. a secrit key(Application.config.secret_key_base) is used to calculate a digist, 
this digist is saved in cookie too, in this way server can know if the cookie has been changed.
</p>
<p>
In order to prevent session stealing from http request, set "force_ssl" to Application(or set nginx).
</p></div>

</div>

<div id="outline-container-9-2" class="outline-3">
<h3 id="sec-9-2">Replay attacks</h3>
<div class="outline-text-3" id="text-9-2">

<p>User save the cookie content =&gt; do something =&gt; replace the cookie with the saved one.
</p>
<p>
To solve the problem, do not save important info in sessions.
</p></div>

</div>

<div id="outline-container-9-3" class="outline-3">
<h3 id="sec-9-3">Session Fixation</h3>
<div class="outline-text-3" id="text-9-3">

<p>Change the victims session id(Due to an xss vulnerable website) =&gt; Ask the victim to login =&gt; Attackers can use the session id now.
</p>
<p>
"reset_session" after user login.
</p></div>

</div>

<div id="outline-container-9-4" class="outline-3">
<h3 id="sec-9-4">Log files</h3>
<div class="outline-text-3" id="text-9-4">

<p>Log files should not contain password, credit card number etc.
</p>


<pre class="src src-ruby">config.filter_parameters &lt;&lt; <span style="color: #268bd2;">:password</span>
</pre>

</div>
</div>

</div>

<div id="outline-container-10" class="outline-2">
<h2 id="sec-10">Caching</h2>
<div class="outline-text-2" id="text-10">

<p>By default rails using fragment cache(binded to an action).
</p>


<pre class="src src-erb">&lt;% cache do %&gt;
  &lt;p&gt;This cache bind to the action.&lt;/p&gt;
&lt;% end %&gt;

&lt;% cache(action: 'recent', action_suffix: 'fragment_1') do %&gt;
  &lt;p&gt;If more than one fragment needs be cached in one action, a 'action_suffix' is needed.&lt;/p&gt;
&lt;% end %&gt;

&lt;% cache(<span style="color: #2aa198;">"fragment_cache_1"</span>) %&gt;
  &lt;p&gt;Name a cache, then the cache can be used all actions in this controller.&lt;/p&gt;
&lt;% end %&gt;

&lt;% cache(obj) %&gt;
  &lt;%= debug obj %&gt;
  &lt;p&gt;It is a good idea to use an object as the cache key, the key will be something like 'obj/id-updat_at_timestamp'. 
  In this case, when the object has been updated, the cache will not be used.&lt;/p&gt;
&lt;% end %&gt;

# Use expire_fragment method to expire cache.
expire_fragment(controller: 'products', action: 'recent', action_suffix: 'all_products')
expire_fragment(<span style="color: #2aa198;">"fragment_cache_1"</span>)
</pre>


</div>

<div id="outline-container-10-1" class="outline-3">
<h3 id="sec-10-1">Cache stores</h3>
<div class="outline-text-3" id="text-10-1">

<p>Set cache store in configuration files.
</p>


<pre class="src src-ruby"><span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">config/application.rb</span>
config.cache_store = <span style="color: #268bd2;">:memory_store</span>
</pre>


</div>

<div id="outline-container-10-1-1" class="outline-4">
<h4 id="sec-10-1-1">Implements own store</h4>
<div class="outline-text-4" id="text-10-1-1">




<pre class="src src-ruby"><span style="color: #859900;">class</span> <span style="color: #268bd2;">MyStore</span> &lt; <span style="color: #268bd2;">ActiveSupport</span>::<span style="color: #268bd2;">Cache</span>::<span style="color: #268bd2;">Store</span>
    <span style="color: #859900;">def</span> <span style="color: #b58900;">initialize</span>(<span style="color: #268bd2;">:namespace</span>,
                   <span style="color: #268bd2;">:expires_in</span>, <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">cache expires time.</span>
                   <span style="color: #268bd2;">:race_condition_ttl</span>)
        <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">:race_condition_ttl option will prevent race conditions </span>
        <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">when cache entries expire by preventing multiple processes </span>
        <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">from simultaneously regenerating the same entry. </span>
        <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">It sets the number of seconds that an expired entry can be reused while a new value is being regenerated.</span>
    <span style="color: #859900;">end</span>
    <span style="color: #859900;">def</span> <span style="color: #b58900;">read</span> <span style="color: #859900;">end</span>
    <span style="color: #859900;">def</span> <span style="color: #b58900;">write</span> <span style="color: #859900;">end</span>
    <span style="color: #859900;">def</span> <span style="color: #b58900;">delete</span> <span style="color: #859900;">end</span>
    <span style="color: #859900;">def</span> <span style="color: #b58900;">exist?</span> <span style="color: #859900;">end</span>
    <span style="color: #859900;">def</span> <span style="color: #b58900;">fetch</span> 
        <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">The fetch method takes a block and will either return an existing value from the cache, </span>
        <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">or evaluate the block and write the result to the cache if no value exists.</span>
    <span style="color: #859900;">end</span> 
<span style="color: #859900;">end</span>
</pre>

</div>
</div>
</div>

</div>

<div id="outline-container-11" class="outline-2">
<h2 id="sec-11">Debug</h2>
<div class="outline-text-2" id="text-11">

<p>Print object in yaml format in view.
</p>


<pre class="src src-ruby">&lt;<span style="color: #2aa198;">%= debug @post %&gt;</span>
</pre>


</div>

<div id="outline-container-11-1" class="outline-3">
<h3 id="sec-11-1">Logger</h3>
<div class="outline-text-3" id="text-11-1">

<p>Saved in /log/[development|test|production].log as default.
</p>


<pre class="src src-ruby">logger.error(<span style="color: #2aa198;">"error message"</span>)
logger.info(<span style="color: #2aa198;">"infomation"</span>)
</pre>

<p>
Logger can be changed in environment.rb.
</p>


<pre class="src src-ruby"><span style="color: #268bd2;">Rails</span>.logger = <span style="color: #268bd2;">Logger</span>.new(<span style="color: #268bd2;">STDOUT</span>)
<span style="color: #268bd2;">Rails</span>.logger = <span style="color: #268bd2;">Log4r</span>::<span style="color: #268bd2;">Logger</span>.new(<span style="color: #2aa198;">"Application Log"</span>)
<span style="color: #268bd2;">Rails</span>.logger.level = 0 <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">at any time</span>
</pre>

<p>
Logger level is info in production &amp; debug in both test and development by default.
</p></div>
</div>

</div>

<div id="outline-container-12" class="outline-2">
<h2 id="sec-12">Others</h2>
<div class="outline-text-2" id="text-12">


</div>

<div id="outline-container-12-1" class="outline-4">
<h4 id="sec-12-1">Bootstrap integration</h4>
<div class="outline-text-4" id="text-12-1">




<pre class="src src-ruby">gem <span style="color: #2aa198;">'bootstrap-sass'</span>, <span style="color: #2aa198;">'~&gt; 3.1.1'</span>
</pre>

<p>
Add "= require bootstrap" to application.css
</p><ul>
<li id="sec-12-1-1">Define custom varaibles &amp; use bootstrap variables<br/>
Instead of add "*= require bootstrap" to application.css. use @import to import bootstrap.



<pre class="src src-css"><span style="color: #93a1a1; font-style: italic;">/* </span><span style="color: #93a1a1; font-style: italic;">varaibles.scss </span><span style="color: #93a1a1; font-style: italic;">*/</span>
<span style="color: #6c71c4;">@import</span> <span style="color: #2aa198;">"bootstrap/variables"</span>;
$brand-primary: <span style="color: #000000; background-color: #ddd;">#ddd</span>; # Add custom variables;
</pre>


<pre class="src src-css"><span style="color: #93a1a1; font-style: italic;">/* </span><span style="color: #93a1a1; font-style: italic;">bootstrap_custom.scss </span><span style="color: #93a1a1; font-style: italic;">*/</span>
<span style="color: #6c71c4;">@import</span> <span style="color: #2aa198;">"bootstrap-sprockets"</span>; # Do not change the order
<span style="color: #6c71c4;">@import</span> <span style="color: #2aa198;">"variables"</span>;
<span style="color: #6c71c4;">@import</span> <span style="color: #2aa198;">"bootstrap"</span>;
</pre>

<p>
Rename application.css to application.scss
</p>


<pre class="src src-css"><span style="color: #93a1a1; font-style: italic;">/* </span><span style="color: #93a1a1; font-style: italic;">application.scss </span><span style="color: #93a1a1; font-style: italic;">*/</span>
<span style="color: #6c71c4;">@import</span> <span style="color: #2aa198;">"bootstrap_custom"</span>
</pre>

</li>
</ul>
</div>

</div>

<div id="outline-container-12-2" class="outline-4">
<h4 id="sec-12-2">Load config files</h4>
<div class="outline-text-4" id="text-12-2">




<pre class="src src-ruby"><span style="color: #268bd2;">YAML</span>.load_file(<span style="color: #268bd2;">Rails</span>.root.join(<span style="color: #2aa198;">"config/drawing.yml"</span>))
</pre>

</div>

</div>

<div id="outline-container-12-3" class="outline-4">
<h4 id="sec-12-3">Nested attributes</h4>
<div class="outline-text-4" id="text-12-3">

<p>Remember to add accepts_nested_attributes_for method to tell rails, treat that attribute as a nested array.
</p>


<pre class="src src-ruby"><span style="color: #859900;">class</span> <span style="color: #268bd2;">Product</span> &lt; <span style="color: #268bd2;">ActiveRecord</span>::<span style="color: #268bd2;">Base</span>
        has_many <span style="color: #268bd2;">:attrs</span>
        accepts_nested_attributes_for <span style="color: #268bd2;">:attrs</span>
<span style="color: #859900;">end</span>
</pre>

</div>
</div>

</div>

<div id="outline-container-13" class="outline-2">
<h2 id="sec-13">Publish</h2>
<div class="outline-text-2" id="text-13">


</div>

<div id="outline-container-13-1" class="outline-3">
<h3 id="sec-13-1">Install ruby with rvm</h3>
<div class="outline-text-3" id="text-13-1">




<pre class="src src-bash">curl -sSL https://rvm.io/mpapis.asc | gpg --import -
curl -sSL https://get.rvm.io | bash -s stable --ruby
</pre>

</div>

</div>

<div id="outline-container-13-2" class="outline-3">
<h3 id="sec-13-2">install rails</h3>
<div class="outline-text-3" id="text-13-2">




<pre class="src src-bash">gem install rails
</pre>

</div>

</div>

<div id="outline-container-13-3" class="outline-3">
<h3 id="sec-13-3">Using Passanger</h3>
<div class="outline-text-3" id="text-13-3">




<pre class="src src-bash">gem install passenger
rvmsudo passenger-install-nginx-module
</pre>


</div>

<div id="outline-container-13-3-1" class="outline-4">
<h4 id="sec-13-3-1">nginx settings</h4>
<div class="outline-text-4" id="text-13-3-1">

<p>nginx.conf
</p>


<pre class="src src-text">server { 
listen 80; 
server_name example.com; 
passenger_enabled on; 
root /var/www/my_awesome_rails_app/public; 
}
</pre>

</div>
</div>
</div>
</div>
</div>

<div id="postamble">
<p class="date">Date: 2015-06-25T21:38+0800</p>
<p class="author">Author: rexhouy</p>
<p class="creator"><a href="http://orgmode.org">Org</a> version 7.9.3f with <a href="http://www.gnu.org/software/emacs/">Emacs</a> version 24</p>
<a href="http://validator.w3.org/check?uri=referer">Validate XHTML 1.0</a>

</div>
</body>
</html>
